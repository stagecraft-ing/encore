From 8b9e6a63a7209e6888d3b158229fe93e9fac3a96 Mon Sep 17 00:00:00 2001
From: Bartek Kus <7887446+bartekus@users.noreply.github.com>
Date: Thu, 5 Feb 2026 14:18:40 -0700
Subject: [PATCH] Fix Zig compiler path resolution and cache configuration

- Add resolveZigBinary() with intelligent fallback chain
  (ENCORE_ZIG → legacy path → PATH)
- Configure ZIG_GLOBAL_CACHE_DIR to avoid permission issues in CI
- Set cache to ~/.cache/encore-build-cache/zig
- Fix env var override bug that was discarding cache config

This fixes three build errors:
1. "cgo: C compiler '/usr/local/zig-0.9.1/zig' not found"
2. "unable to create compilation: AccessDenied"
3. Environment variable being overwritten in darwin/linux-arm64 builds

The critical bug was using envs = []string{} instead of append(),
which overwrote ZIG_GLOBAL_CACHE_DIR when setting CGO_LDFLAGS for
cross-compilation scenarios.

Modified:
- pkg/encorebuild/compile/compile.go: Add resolver, cache, fix append
- pkg/make-release/compilers.go: Add resolver, cache, fix append

Documentation:
- .changes/encore-cli-patch/zig-path-resolution-fix.md
---
 pkg/encorebuild/compile/compile.go | 46 +++++++++++++++++++++++++-----
 pkg/make-release/compilers.go      | 46 +++++++++++++++++++++++++-----
 2 files changed, 78 insertions(+), 14 deletions(-)

diff --git a/pkg/encorebuild/compile/compile.go b/pkg/encorebuild/compile/compile.go
index 4c2da4a..9b30302 100644
--- a/pkg/encorebuild/compile/compile.go
+++ b/pkg/encorebuild/compile/compile.go
@@ -12,6 +12,34 @@ import (
 	. "encr.dev/pkg/encorebuild/buildutil"
 )
 
+// resolveZigBinary returns the path to the Zig binary to use for compilation.
+// It checks in order: ENCORE_ZIG env var, legacy path, then PATH.
+// Environment Variables:
+//
+//	ENCORE_ZIG - Override Zig binary path (e.g., "/opt/homebrew/bin/zig")
+func resolveZigBinary() string {
+	// 1. Check ENCORE_ZIG environment variable
+	if zigPath := osPkg.Getenv("ENCORE_ZIG"); zigPath != "" {
+		if _, err := osPkg.Stat(zigPath); err == nil {
+			return zigPath
+		}
+	}
+
+	// 2. Check legacy hardcoded path for backward compatibility
+	legacyPath := "/usr/local/zig-0.9.1/zig"
+	if _, err := osPkg.Stat(legacyPath); err == nil {
+		return legacyPath
+	}
+
+	// 3. Try to find zig in PATH
+	if zigPath, err := exec.LookPath("zig"); err == nil {
+		return zigPath
+	}
+
+	// Fallback to "zig" and let exec provide error
+	return "zig"
+}
+
 // GoBinary compiles a Go binary for the given OS and architecture with GCP enabled
 //
 // This file was inspired by the blog post: https://lucor.dev/post/cross-compile-golang-fyne-project-using-zig/
@@ -211,9 +239,17 @@ func compilerSettings(cfg *buildconf.Config) (cc, cxx string, envs, ldFlags []st
 	var zigArgs string
 	zigBinary := "zig"
 
+	// Set up Zig cache directory to avoid permission issues in CI
+	cacheDir, cacheErr := osPkg.UserCacheDir()
+	if cacheErr == nil {
+		zigCacheDir := filepath.Join(cacheDir, "encore-build-cache", "zig")
+		_ = osPkg.MkdirAll(zigCacheDir, 0755)
+		envs = append(envs, "ZIG_GLOBAL_CACHE_DIR="+zigCacheDir)
+	}
+
 	switch cfg.OS {
 	case "darwin":
-		zigBinary = "/usr/local/zig-0.9.1/zig" // We need an explicit version of Zig for darwin (0.11.0 compiles, build causes runtime errors)
+		zigBinary = resolveZigBinary()
 		ldFlags = []string{"-s", "-w"}
 
 		switch cfg.Arch {
@@ -229,9 +265,7 @@ func compilerSettings(cfg *buildconf.Config) (cc, cxx string, envs, ldFlags []st
 		if cfg.IsCross() {
 			sdkPath := cfg.CrossMacSDKPath()
 			zigArgs = " -isysroot " + sdkPath + " -iwithsysroot /usr/include -iframeworkwithsysroot /System/Library/Frameworks"
-			envs = []string{
-				"CGO_LDFLAGS=--sysroot " + sdkPath + " -F/System/Library/Frameworks -L/usr/lib",
-			}
+			envs = append(envs, "CGO_LDFLAGS=--sysroot "+sdkPath+" -F/System/Library/Frameworks -L/usr/lib")
 		}
 
 	case "linux":
@@ -244,9 +278,7 @@ func compilerSettings(cfg *buildconf.Config) (cc, cxx string, envs, ldFlags []st
 		case "arm64":
 			zigTarget = "aarch64-linux-gnu.2.31"
 			zigArgs = " -static -isystem /usr/include"
-			envs = []string{
-				"PKG_CONFIG_LIBDIR=/usr/lib/aarch64-linux-gnu/pkgconfig",
-			}
+			envs = append(envs, "PKG_CONFIG_LIBDIR=/usr/lib/aarch64-linux-gnu/pkgconfig")
 		default:
 			Bailf("unsupported architecture for linux: %q", cfg.Arch)
 		}
diff --git a/pkg/make-release/compilers.go b/pkg/make-release/compilers.go
index 412c16e..ffdcae8 100644
--- a/pkg/make-release/compilers.go
+++ b/pkg/make-release/compilers.go
@@ -11,6 +11,34 @@ import (
 	"github.com/cockroachdb/errors"
 )
 
+// resolveZigBinary returns the path to the Zig binary to use for compilation.
+// It checks in order: ENCORE_ZIG env var, legacy path, then PATH.
+// Environment Variables:
+//
+//	ENCORE_ZIG - Override Zig binary path (e.g., "/opt/homebrew/bin/zig")
+func resolveZigBinary() string {
+	// 1. Check ENCORE_ZIG environment variable
+	if zigPath := osPkg.Getenv("ENCORE_ZIG"); zigPath != "" {
+		if _, err := osPkg.Stat(zigPath); err == nil {
+			return zigPath
+		}
+	}
+
+	// 2. Check legacy hardcoded path for backward compatibility
+	legacyPath := "/usr/local/zig-0.9.1/zig"
+	if _, err := osPkg.Stat(legacyPath); err == nil {
+		return legacyPath
+	}
+
+	// 3. Try to find zig in PATH
+	if zigPath, err := exec.LookPath("zig"); err == nil {
+		return zigPath
+	}
+
+	// Fallback to "zig" and let exec provide error
+	return "zig"
+}
+
 // MacOSSDKPath is the path to where the MacOS SDK is located on Encore's builder systems
 const MacOSSDKPath = "/sdk"
 
@@ -198,9 +226,17 @@ func compilerSettings(os string, arch string) (cc, cxx string, envs, ldFlags []s
 	var zigArgs string
 	zigBinary := "zig" // pick it up off the path
 
+	// Set up Zig cache directory to avoid permission issues in CI
+	cacheDir, cacheErr := osPkg.UserCacheDir()
+	if cacheErr == nil {
+		zigCacheDir := filepath.Join(cacheDir, "encore-build-cache", "zig")
+		_ = osPkg.MkdirAll(zigCacheDir, 0755)
+		envs = append(envs, "ZIG_GLOBAL_CACHE_DIR="+zigCacheDir)
+	}
+
 	switch os {
 	case "darwin":
-		zigBinary = "/usr/local/zig-0.9.1/zig" // We need an explicit version of Zig for darwin (0.11.0 compiles, build causes runtime errors)
+		zigBinary = resolveZigBinary()
 		ldFlags = []string{"-s", "-w"}
 
 		switch arch {
@@ -215,9 +251,7 @@ func compilerSettings(os string, arch string) (cc, cxx string, envs, ldFlags []s
 		// We need to set some extra stuff if we're cross compiling to MacOS
 		if runtime.GOOS != "darwin" {
 			zigArgs = " -isysroot " + MacOSSDKPath + " -iwithsysroot /usr/include -iframeworkwithsysroot /System/Library/Frameworks"
-			envs = []string{
-				"CGO_LDFLAGS=--sysroot " + MacOSSDKPath + " -F/System/Library/Frameworks -L/usr/lib",
-			}
+			envs = append(envs, "CGO_LDFLAGS=--sysroot "+MacOSSDKPath+" -F/System/Library/Frameworks -L/usr/lib")
 		}
 
 	case "linux":
@@ -228,9 +262,7 @@ func compilerSettings(os string, arch string) (cc, cxx string, envs, ldFlags []s
 		case "arm64":
 			zigTarget = "aarch64-linux-gnu"
 			zigArgs = " -static -isystem /usr/include"
-			envs = []string{
-				"PKG_CONFIG_LIBDIR=/usr/lib/aarch64-linux-gnu/pkgconfig",
-			}
+			envs = append(envs, "PKG_CONFIG_LIBDIR=/usr/lib/aarch64-linux-gnu/pkgconfig")
 		default:
 			return "", "", nil, nil, errors.New("unsupported architecture for linux: " + arch)
 		}
-- 
2.50.1 (Apple Git-155)


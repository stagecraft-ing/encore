From 63379825459a474744157354516f09c26eacf43e Mon Sep 17 00:00:00 2001
From: Bartek Kus <7887446+bartekus@users.noreply.github.com>
Date: Thu, 5 Feb 2026 12:44:40 -0700
Subject: [PATCH] Fix Zig compiler path resolution and cache configuration

- Add resolveZigBinary() with intelligent fallback chain
  (ENCORE_ZIG → legacy path → PATH)
- Configure ZIG_GLOBAL_CACHE_DIR to avoid permission issues in CI
- Set cache to ~/.cache/encore-build-cache/zig

This fixes two build errors:
1. "cgo: C compiler '/usr/local/zig-0.9.1/zig' not found"
2. "unable to create compilation: AccessDenied"

The hardcoded Zig path doesn't exist in CI or local dev environments.
The new resolver checks multiple locations and falls back gracefully.

Zig's cache directory requires write permissions. In restrictive CI
environments, setting ZIG_GLOBAL_CACHE_DIR to a known writable location
prevents AccessDenied errors.

Modified:
- pkg/encorebuild/compile/compile.go: Add resolver and cache config
- pkg/make-release/compilers.go: Add resolver and cache config

Documentation:
- .changes/encore-cli-patch/zig-path-resolution-fix.md
---
 pkg/encorebuild/compile/compile.go | 38 +++++++++++++++++++++++++++++-
 pkg/make-release/compilers.go      | 38 +++++++++++++++++++++++++++++-
 2 files changed, 74 insertions(+), 2 deletions(-)

diff --git a/pkg/encorebuild/compile/compile.go b/pkg/encorebuild/compile/compile.go
index 4c2da4a0..153953d1 100644
--- a/pkg/encorebuild/compile/compile.go
+++ b/pkg/encorebuild/compile/compile.go
@@ -12,6 +12,34 @@ import (
 	. "encr.dev/pkg/encorebuild/buildutil"
 )
 
+// resolveZigBinary returns the path to the Zig binary to use for compilation.
+// It checks in order: ENCORE_ZIG env var, legacy path, then PATH.
+// Environment Variables:
+//
+//	ENCORE_ZIG - Override Zig binary path (e.g., "/opt/homebrew/bin/zig")
+func resolveZigBinary() string {
+	// 1. Check ENCORE_ZIG environment variable
+	if zigPath := osPkg.Getenv("ENCORE_ZIG"); zigPath != "" {
+		if _, err := osPkg.Stat(zigPath); err == nil {
+			return zigPath
+		}
+	}
+
+	// 2. Check legacy hardcoded path for backward compatibility
+	legacyPath := "/usr/local/zig-0.9.1/zig"
+	if _, err := osPkg.Stat(legacyPath); err == nil {
+		return legacyPath
+	}
+
+	// 3. Try to find zig in PATH
+	if zigPath, err := exec.LookPath("zig"); err == nil {
+		return zigPath
+	}
+
+	// Fallback to "zig" and let exec provide error
+	return "zig"
+}
+
 // GoBinary compiles a Go binary for the given OS and architecture with GCP enabled
 //
 // This file was inspired by the blog post: https://lucor.dev/post/cross-compile-golang-fyne-project-using-zig/
@@ -211,9 +239,17 @@ func compilerSettings(cfg *buildconf.Config) (cc, cxx string, envs, ldFlags []st
 	var zigArgs string
 	zigBinary := "zig"
 
+	// Set up Zig cache directory to avoid permission issues in CI
+	cacheDir, cacheErr := osPkg.UserCacheDir()
+	if cacheErr == nil {
+		zigCacheDir := filepath.Join(cacheDir, "encore-build-cache", "zig")
+		_ = osPkg.MkdirAll(zigCacheDir, 0755)
+		envs = append(envs, "ZIG_GLOBAL_CACHE_DIR="+zigCacheDir)
+	}
+
 	switch cfg.OS {
 	case "darwin":
-		zigBinary = "/usr/local/zig-0.9.1/zig" // We need an explicit version of Zig for darwin (0.11.0 compiles, build causes runtime errors)
+		zigBinary = resolveZigBinary()
 		ldFlags = []string{"-s", "-w"}
 
 		switch cfg.Arch {
diff --git a/pkg/make-release/compilers.go b/pkg/make-release/compilers.go
index 412c16eb..ffff3f66 100644
--- a/pkg/make-release/compilers.go
+++ b/pkg/make-release/compilers.go
@@ -11,6 +11,34 @@ import (
 	"github.com/cockroachdb/errors"
 )
 
+// resolveZigBinary returns the path to the Zig binary to use for compilation.
+// It checks in order: ENCORE_ZIG env var, legacy path, then PATH.
+// Environment Variables:
+//
+//	ENCORE_ZIG - Override Zig binary path (e.g., "/opt/homebrew/bin/zig")
+func resolveZigBinary() string {
+	// 1. Check ENCORE_ZIG environment variable
+	if zigPath := osPkg.Getenv("ENCORE_ZIG"); zigPath != "" {
+		if _, err := osPkg.Stat(zigPath); err == nil {
+			return zigPath
+		}
+	}
+
+	// 2. Check legacy hardcoded path for backward compatibility
+	legacyPath := "/usr/local/zig-0.9.1/zig"
+	if _, err := osPkg.Stat(legacyPath); err == nil {
+		return legacyPath
+	}
+
+	// 3. Try to find zig in PATH
+	if zigPath, err := exec.LookPath("zig"); err == nil {
+		return zigPath
+	}
+
+	// Fallback to "zig" and let exec provide error
+	return "zig"
+}
+
 // MacOSSDKPath is the path to where the MacOS SDK is located on Encore's builder systems
 const MacOSSDKPath = "/sdk"
 
@@ -198,9 +226,17 @@ func compilerSettings(os string, arch string) (cc, cxx string, envs, ldFlags []s
 	var zigArgs string
 	zigBinary := "zig" // pick it up off the path
 
+	// Set up Zig cache directory to avoid permission issues in CI
+	cacheDir, cacheErr := osPkg.UserCacheDir()
+	if cacheErr == nil {
+		zigCacheDir := filepath.Join(cacheDir, "encore-build-cache", "zig")
+		_ = osPkg.MkdirAll(zigCacheDir, 0755)
+		envs = append(envs, "ZIG_GLOBAL_CACHE_DIR="+zigCacheDir)
+	}
+
 	switch os {
 	case "darwin":
-		zigBinary = "/usr/local/zig-0.9.1/zig" // We need an explicit version of Zig for darwin (0.11.0 compiles, build causes runtime errors)
+		zigBinary = resolveZigBinary()
 		ldFlags = []string{"-s", "-w"}
 
 		switch arch {
-- 
2.50.1 (Apple Git-155)

